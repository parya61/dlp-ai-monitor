
# Список сервисов (контейнеров)
services:
  # Имя сервиса (можешь назвать как хочешь)
  api:
    # Собрать образ из Dockerfile в текущей папке
    build:
      context: .           # Где искать Dockerfile (. = текущая папка)
      dockerfile: Dockerfile
    
    # Имя контейнера (для удобства в логах)
    container_name: dlp-ai-monitor-api
    
    # Проброс портов: ХОСТ:КОНТЕЙНЕР
    # ЗАЧЕМ: 8000 внутри контейнера → 8000 на твоём компе
    # Теперь http://localhost:8000 достучится до API
    ports:
      - "8000:8000"
    
    # Монтирование папок: ХОСТ:КОНТЕЙНЕР
    # ЗАЧЕМ: Изменения в коде сразу видны в контейнере (не нужна пересборка!)
    volumes:
      # Синхронизируем код (для --reload в uvicorn)
      - ./src:/app/src
      - ./api:/app/api
      
      # Синхронизируем данные и модели
      - ./data:/app/data
      - ./models:/app/models
      
      # Логи сохраняются на хост-машине
      - ./logs:/app/logs
    
    # Переменные окружения
    # ЗАЧЕМ: Настройки без изменения кода
    environment:
      - PYTHONUNBUFFERED=1   # Логи сразу в stdout (не буферизуются)
      - LOG_LEVEL=INFO       # Уровень логирования
    
    # Политика перезапуска
    # ЗАЧЕМ: Если контейнер упал → автоматически перезапустится
    restart: unless-stopped
    
    # Healthcheck - проверка что API живо
    # ЗАЧЕМ: Docker будет проверять доступность каждые 30 сек
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s      # Проверять каждые 30 секунд
      timeout: 10s       # Таймаут ответа
      retries: 3         # Количество попыток
      start_period: 40s  # Подождать 40 сек перед первой проверкой