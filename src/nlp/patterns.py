"""
src/nlp/patterns.py

–ß–¢–û: Regex –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è —Ä–æ—Å—Å–∏–π—Å–∫–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
–ó–ê–ß–ï–ú: –ü–æ–∏—Å–∫ PII –≤ —Ç–µ–∫—Å—Ç–∞—Ö (–Ω–æ–º–µ—Ä–∞ –∫–∞—Ä—Ç, –ø–∞—Å–ø–æ—Ä—Ç–∞, –ò–ù–ù, –°–ù–ò–õ–°, —Ç–µ–ª–µ—Ñ–æ–Ω—ã)

–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    from src.nlp.patterns import CARD_PATTERN, PASSPORT_PATTERN
    
    text = "–ö–∞—Ä—Ç–∞: 1234 5678 9012 3456"
    cards = CARD_PATTERN.findall(text)
    print(cards)  # ['1234 5678 9012 3456']
"""

import re

# =============================================================================
# –ë–ê–ù–ö–û–í–°–ö–ò–ï –ö–ê–†–¢–´
# =============================================================================

# –§–æ—Ä–º–∞—Ç: XXXX XXXX XXXX XXXX (4 –≥—Ä—É–ø–ø—ã –ø–æ 4 —Ü–∏—Ñ—Ä—ã)
# –ü—Ä–∏–º–µ—Ä—ã:
#   - 1234 5678 9012 3456
#   - 4276 1234 5678 9012
CARD_PATTERN = re.compile(
    r"\b\d{4}\s\d{4}\s\d{4}\s\d{4}\b"
)

# =============================================================================
# –ü–ê–°–ü–û–†–¢ –†–§
# =============================================================================

# –§–æ—Ä–º–∞—Ç: XXXX XXXXXX (—Å–µ—Ä–∏—è 4 —Ü–∏—Ñ—Ä—ã, –Ω–æ–º–µ—Ä 6 —Ü–∏—Ñ—Ä)
# –ü—Ä–∏–º–µ—Ä—ã:
#   - 4567 123456
#   - 1234 567890
PASSPORT_PATTERN = re.compile(
    r"\b\d{4}\s\d{6}\b"
)

# =============================================================================
# –ò–ù–ù (–ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–æ–Ω–Ω—ã–π –ù–æ–º–µ—Ä –ù–∞–ª–æ–≥–æ–ø–ª–∞—Ç–µ–ª—å—â–∏–∫–∞)
# =============================================================================

# –§–æ—Ä–º–∞—Ç: 12 —Ü–∏—Ñ—Ä –ø–æ–¥—Ä—è–¥ (–¥–ª—è —Ñ–∏–∑–∏—á–µ—Å–∫–∏—Ö –ª–∏—Ü)
# –ü—Ä–∏–º–µ—Ä—ã:
#   - 123456789012
#   - 500100732259
# 
# –í–ê–ñ–ù–û: –∏—Å–ø–æ–ª—å–∑—É–µ–º \b (–≥—Ä–∞–Ω–∏—Ü—ã —Å–ª–æ–≤–∞), —á—Ç–æ–±—ã –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—å –ò–ù–ù –≤–Ω—É—Ç—Ä–∏ –¥—Ä—É–≥–∏—Ö —á–∏—Å–µ–ª
INN_PATTERN = re.compile(
    r"\b\d{12}\b"
)

# =============================================================================
# –°–ù–ò–õ–° (–°—Ç—Ä–∞—Ö–æ–≤–æ–π –ù–æ–º–µ—Ä –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–≥–æ –õ–∏—Ü–µ–≤–æ–≥–æ –°—á—ë—Ç–∞)
# =============================================================================

# –§–æ—Ä–º–∞—Ç: XXX-XXX-XXX YY (3 –≥—Ä—É–ø–ø—ã –ø–æ 3 —Ü–∏—Ñ—Ä—ã, –ø—Ä–æ–±–µ–ª, 2 —Ü–∏—Ñ—Ä—ã –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π —Å—É–º–º—ã)
# –ü—Ä–∏–º–µ—Ä—ã:
#   - 123-456-789 12
#   - 987-654-321 00
SNILS_PATTERN = re.compile(
    r"\b\d{3}-\d{3}-\d{3}\s\d{2}\b"
)

# =============================================================================
# –¢–ï–õ–ï–§–û–ù–´ (—Ä–æ—Å—Å–∏–π—Å–∫–∏–µ)
# =============================================================================

# –§–æ—Ä–º–∞—Ç—ã (–≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã):
#   - +79991234567
#   - 89991234567
#   - +7 999 123 45 67
#   - 8 (999) 123-45-67
#   - +7 (999) 123-45-67
#
# Regex —Ä–∞–∑–±–æ—Ä:
# - (\+7|8) = –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å +7 –∏–ª–∏ 8
# - [\s\-\(]? = –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–±–µ–ª, –¥–µ—Ñ–∏—Å –∏–ª–∏ –æ—Ç–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞
# - \d{3} = 3 —Ü–∏—Ñ—Ä—ã (–∫–æ–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞)
# - [\s\-\)]? = –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–±–µ–ª, –¥–µ—Ñ–∏—Å –∏–ª–∏ –∑–∞–∫—Ä—ã–≤–∞—é—â–∞—è —Å–∫–æ–±–∫–∞
# - \d{3} = 3 —Ü–∏—Ñ—Ä—ã
# - [\s\-]? = –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–±–µ–ª –∏–ª–∏ –¥–µ—Ñ–∏—Å
# - \d{2} = 2 —Ü–∏—Ñ—Ä—ã
# - [\s\-]? = –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ–±–µ–ª –∏–ª–∏ –¥–µ—Ñ–∏—Å
# - \d{2} = 2 —Ü–∏—Ñ—Ä—ã
PHONE_PATTERN = re.compile(
    r"(\+7|8)[\s\-\(]?\d{3}[\s\-\)]?\d{3}[\s\-]?\d{2}[\s\-]?\d{2}"
)

# =============================================================================
# EMAIL
# =============================================================================

# –£–ø—Ä–æ—â—ë–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –¥–ª—è email
# –§–æ—Ä–º–∞—Ç: user@domain.com
# 
# –ë–æ–ª–µ–µ —Ç–æ—á–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω (RFC 5322 compliant) –æ—á–µ–Ω—å —Å–ª–æ–∂–Ω—ã–π,
# –ø–æ—ç—Ç–æ–º—É –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–ø—Ä–æ—â—ë–Ω–Ω—ã–π –¥–ª—è 99% —Å–ª—É—á–∞–µ–≤
EMAIL_PATTERN = re.compile(
    r"\b[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}\b"
)

# =============================================================================
# –í–°–ï –ü–ê–¢–¢–ï–†–ù–´ (–¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞)
# =============================================================================

ALL_PATTERNS = {
    "card": CARD_PATTERN,
    "passport": PASSPORT_PATTERN,
    "inn": INN_PATTERN,
    "snils": SNILS_PATTERN,
    "phone": PHONE_PATTERN,
    "email": EMAIL_PATTERN,
}


# =============================================================================
# –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ë–´–°–¢–†–û–ì–û –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–Ø
# =============================================================================

def test_patterns(text: str) -> dict:
    """
    –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –≤—Å–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –Ω–∞ –∑–∞–¥–∞–Ω–Ω–æ–º —Ç–µ–∫—Å—Ç–µ.
    
    Args:
        text: –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
    
    Returns:
        Dict —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ —Å–æ–≤–ø–∞–¥–µ–Ω–∏—è–º–∏
    
    Example:
        result = test_patterns("–ö–∞—Ä—Ç–∞: 1234 5678 9012 3456, –ø–∞—Å–ø–æ—Ä—Ç: 4567 123456")
        print(result)
    """
    results = {}
    for name, pattern in ALL_PATTERNS.items():
        matches = pattern.findall(text)
        if matches:
            results[name] = matches
    return results


# =============================================================================
# –ü–†–ò–ú–ï–† –ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–Ø (–¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è)
# =============================================================================

if __name__ == "__main__":
    # –¢–µ—Å—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç —Å —Ä–∞–∑–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏ PII
    test_text = """
    –î–æ–±—Ä—ã–π –¥–µ–Ω—å! –í—ã—Å—ã–ª–∞—é –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞:
    
    –ö–∞—Ä—Ç–∞: 1234 5678 9012 3456
    –ü–∞—Å–ø–æ—Ä—Ç: 4567 123456
    –ò–ù–ù: 123456789012
    –°–ù–ò–õ–°: 123-456-789 12
    –¢–µ–ª–µ—Ñ–æ–Ω: +79991234567
    Email: ivan.ivanov@example.com
    
    –¢–∞–∫–∂–µ –µ—Å—Ç—å –≤—Ç–æ—Ä–æ–π —Ç–µ–ª–µ—Ñ–æ–Ω: 8 (999) 123-45-67
    –ò –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∫–∞—Ä—Ç–∞: 4276 8888 7777 6666
    """
    
    print("=" * 80)
    print("TESTING REGEX PATTERNS")
    print("=" * 80)
    
    print("\nüìÑ Test text:")
    print(test_text)
    
    print("\n" + "=" * 80)
    print("RESULTS:")
    print("=" * 80)
    
    # –¢–µ—Å—Ç–∏—Ä—É–µ–º –∫–∞–∂–¥—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω
    print("\nüí≥ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–µ –∫–∞—Ä—Ç—ã:")
    cards = CARD_PATTERN.findall(test_text)
    print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(cards)}")
    for card in cards:
        print(f"   - {card}")
    
    print("\nüìï –ü–∞—Å–ø–æ—Ä—Ç–∞ –†–§:")
    passports = PASSPORT_PATTERN.findall(test_text)
    print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(passports)}")
    for passport in passports:
        print(f"   - {passport}")
    
    print("\nüî¢ –ò–ù–ù:")
    inn_list = INN_PATTERN.findall(test_text)
    print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(inn_list)}")
    for inn in inn_list:
        print(f"   - {inn}")
    
    print("\nüìã –°–ù–ò–õ–°:")
    snils_list = SNILS_PATTERN.findall(test_text)
    print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(snils_list)}")
    for snils in snils_list:
        print(f"   - {snils}")
    
    print("\nüì± –¢–µ–ª–µ—Ñ–æ–Ω—ã:")
    phones = PHONE_PATTERN.findall(test_text)
    print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(phones)}")
    for phone in phones:
        print(f"   - {phone}")
    
    print("\nüìß Email:")
    emails = EMAIL_PATTERN.findall(test_text)
    print(f"   –ù–∞–π–¥–µ–Ω–æ: {len(emails)}")
    for email in emails:
        print(f"   - {email}")
    
    print("\n" + "=" * 80)
    print("SUMMARY:")
    print("=" * 80)
    
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ—É–Ω–∫—Ü–∏—é test_patterns
    all_results = test_patterns(test_text)
    print(f"\n–í—Å–µ–≥–æ –Ω–∞–π–¥–µ–Ω–æ —Ç–∏–ø–æ–≤ PII: {len(all_results)}")
    for pii_type, matches in all_results.items():
        print(f"  - {pii_type}: {len(matches)} —à—Ç.")
    
    print("\n" + "=" * 80)